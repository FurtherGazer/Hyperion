<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hyperion</title>
    
    <!-- CSS -->
    <style>
        .canvas-wrapper, #scatter-gl-container {
            display: inline-block;
            vertical-align: top;
        }
        #scatter-gl-container {
            border: solid 1px black;
            position: relative;
        }
        #video {
            -webkit-transform: scaleX(-1);
            transform: scaleX(-1);
            visibility: hidden;
            width: auto;
            height: auto;
            display: none;
        }
        #hide {
            display: none;
        }
    </style>
</head>
<body>
    <div id="main">
        <div class="container">
          <div class="canvas-wrapper">
            <canvas id="output" width="600" height="400" ></canvas>
            <canvas id="hide" width="300" height="300"></canvas>
            <video id="video" playsinline>
          </div>
        </div>
    </div>

    <div>
        <button onclick="main()">开启</button>
        <button id='closeBT' onclick="stopMain()" disabled>停止</button>
    </div>

    <script>
        const NUM_KEYPOINTS = 468;
        const NUM_IRIS_KEYPOINTS = 5;
        const GREEN = '#32EEDB';
        const RED = "#FF2C35";
        const BLUE = "#157AB3";
        const videoWidth = '600';
        const videoHeight = '400';
        window.rafID = null;
        window.animation_status = false;

        canvas = document.getElementById('output');
        canvas_hide = document.getElementById('hide');
        // 此步骤创建了一个和 video 等大的 canvas
        canvas.width = '600';
        canvas.height = '400';
        const canvasContainer = document.querySelector('.canvas-wrapper');
        canvasContainer.style = `width: 600px; height: 400x`;
        // 设置画板属性
        ctx = canvas.getContext('2d');
        // 镜像翻转
        ctx.translate(canvas.width, 0); 
        ctx.scale(-1, 1);
        ctx.fillStyle = GREEN;
        ctx.strokeStyle = GREEN;
        ctx.lineWidth = 2;
        ctx2 = canvas_hide.getContext('2d');
        // 设置图层叠加方案
        ctx.globalCompositeOperation="difference";
        // 其他可选方案: difference 更加柔和
        // 具体可参考: https://developer.mozilla.org/zh-CN/docs/Web/API/CanvasRenderingContext2D/globalCompositeOperation
        async function setupCamera() {
            let constraints = {
                video: {
                    width: 600,
                    height: 400,
                    facingMode: "user"
                },
                audio:false
            };
            // 获得video摄像头区域
            let video = document.getElementById("video");
            // 使关闭摄像头变得可可执行
            let stopBt = document.getElementById("closeBT");
            if (stopBt)stopBt.disabled = false;
            
            const MediaStream = await navigator.mediaDevices.getUserMedia(constraints)
            video.srcObject = MediaStream;
            video.play();
            console.log('Set MediaStream!'); // 对象
            window.CurMediaStream = MediaStream;

            return new Promise( 
                (resolve) => {
                    video.onloadedmetadata = () => {
                        resolve(video); 
                    };
                }
            );
        };

        // stop only camera
        function stopVideoOnly(stream) {
            stream.getTracks().forEach(function(track) {
                if (track.readyState == 'live' && track.kind === 'video') {
                    track.stop();
                }
            });
        };
        function stopMain(){
            if (window.CurMediaStream){
                stopVideoOnly(window.CurMediaStream)
            }else{
                console.log('没有正在运行的 MediaStream')
            }
            window.animation_status = false;
            window.cancelAnimationFrame(window.rafID);     
        };
    </script>

    <script src="./index.js"></script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hyperion</title>

    <!-- Require the peer dependencies of face-landmarks-detection. -->
    <script src="https://unpkg.com/@tensorflow/tfjs-core@2.4.0/dist/tf-core.js"></script>
    <script src="https://unpkg.com/@tensorflow/tfjs-converter@2.4.0/dist/tf-converter.js"></script>

    <!-- You must explicitly require a TF.js backend if you're not using the tfjs union bundle. -->
    <!-- <script src="https://unpkg.com/@tensorflow/tfjs-backend-webgl@2.4.0/dist/tf-backend-webgl.js"></script> -->
    <script src="https://unpkg.com/@tensorflow/tfjs-backend-wasm@2.4.0/dist/tf-backend-wasm.js"></script>

    <!-- Require face-landmarks-detection itself. -->
    <script src="https://unpkg.com/@tensorflow-models/face-landmarks-detection@0.0.1/dist/face-landmarks-detection.js"></script>

    <!-- CSS -->
    <style>
        .canvas-wrapper, #scatter-gl-container {
            display: inline-block;
            vertical-align: top;
        }

        #scatter-gl-container {
            border: solid 1px black;
            position: relative;
        }

        #video {
            -webkit-transform: scaleX(-1);
            transform: scaleX(-1);
            visibility: hidden;
            width: auto;
            height: auto;
            display: none;
        }
    </style>
</head>
<body>
    <div id="main">
        <div class="container">
          <div class="canvas-wrapper">
            <canvas id="output" width="600" height="400" ></canvas>
            <video id="video" playsinline>
          </div>
        </div>
    </div>

    <div>
        <button onclick="main()">开启</button>
        <button id='closeBT' onclick="stopMain()" disabled>停止</button>
    </div>

    <script>
        const NUM_KEYPOINTS = 468;
        const NUM_IRIS_KEYPOINTS = 5;
        const GREEN = '#32EEDB';
        const RED = "#FF2C35";
        const BLUE = "#157AB3";
        const videoWidth = '600';
        const videoHeight = '400';
        window.rafID = null;
        window.animation_status = false;

        canvas = document.getElementById('output');
        canvas.width = '600';
        canvas.height = '400';
        const canvasContainer = document.querySelector('.canvas-wrapper');
        canvasContainer.style = `width: 600px; height: 400x`;
        ctx = canvas.getContext('2d');
        ctx.translate(canvas.width, 0);
        ctx.scale(-1, 1);
        ctx.fillStyle = GREEN;
        ctx.strokeStyle = GREEN;
        ctx.lineWidth = 0.5;

        async function setupCamera() {
            let constraints = {
                video: {
                    width: 600,
                    height: 400,
                    facingMode: "user"
                },
                audio:false
            };
            let video = document.getElementById("video");
            let stopBt = document.getElementById("closeBT");
            if (stopBt)stopBt.disabled = false;
            
            const MediaStream = await navigator.mediaDevices.getUserMedia(constraints)
            video.srcObject = MediaStream;
            video.play();
            console.log(MediaStream); // 对象
            window.CurMediaStream = MediaStream;

            return new Promise( 
                (resolve) => { // 返回一个箭头函数
                    video.onloadedmetadata = () => { // 箭头函数在 video.onloadedmetadata 上绑定了一个箭头事件
                        resolve(video); 
                    };
                }
            );
        };

        function stopVideoOnly(stream) {
            stream.getTracks().forEach(function(track) {
                if (track.readyState == 'live' && track.kind === 'video') {
                    track.stop();
                }
            });
        };
        function stopMain(){
            if (window.CurMediaStream){
                stopVideoOnly(window.CurMediaStream)
            }else{
                console.log('没有正在运行的 MediaStream')
            }
            window.animation_status = false;
            window.cancelAnimationFrame(window.rafID);     
        };
    </script>

    <script src="./index.js"></script>
</body>
</html>